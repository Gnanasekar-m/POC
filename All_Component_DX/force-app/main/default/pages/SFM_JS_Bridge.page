<apex:page sidebar="false" showHeader="false" standardStylesheets="false">

<script type="text/javascript" src="{!URLFOR($Resource.SFM_JS_Bridge, 'SFM_JS_Bridge/jquery-3.0.0.min.js')}"></script>
<script type="text/javascript" src="{!URLFOR($Resource.SFM_JS_Bridge, 'SFM_JS_Bridge/jquery.browser.min.js')}"></script>
<script type="text/javascript" src="{!URLFOR($Resource.SFM_JS_Bridge, 'SFM_JS_Bridge/jquery.inherit-1.3.2.js')}"></script>
<script type="text/javascript" src="{!URLFOR($Resource.SFM_JS_Bridge, 'SFM_JS_Bridge/jquery.parseXml-1.0.0.js')}"></script>
<script type="text/javascript" src="{!URLFOR($Resource.SFM_JS_Bridge, 'SFM_JS_Bridge/jquery.json-2.3.js')}"></script>
<script type="text/javascript" src="{!URLFOR($Resource.SFM_JS_Bridge, 'SFM_JS_Bridge/svmx_ajax.js')}"></script>
<script type="text/javascript" src="{!URLFOR($Resource.SFM_JS_Bridge, 'SFM_JS_Bridge/svmx_client_api.js')}"></script>
<script type="text/javascript" src="{!URLFOR($Resource.SFM_JS_Bridge, 'SFM_JS_Bridge/svmx_js_flex_expression_bridge.js')}"></script>

<script>

jQuery(document).ready(function(){
var id = 0;
window.FlexApp = {
    handleJSExpressionResult : function(result, id){
        debugger;
        alert(result);
    }
};

function snippet(context){
    
    function applyPriceBook(detailRecords, pb){
        var i, l = detailRecords.length;
        for(var i = 0; i < l; i++){
            var records = detailRecords[i].records, j, recordslength = records.length;
            for(j = 0; j < recordslength; j++){
                var record = records[i].targetRecordAsKeyValue, length = record.length, k;
                var lineType = getItemForDetailRecordKey("Line_Type__c", record);
                if(lineType.value == "Parts"){
                    var quantityField = getItemForDetailRecordKey("Quantity2__c", record);
                    var unitPriceField = getItemForDetailRecordKey("Unit_Price2__c", record);
                    var linePriceField = getItemForDetailRecordKey("Line_Price2__c", record);
                    var product = getItemForDetailRecordKey("Product__c", record);
                    var up = getUnitPriceForProduct(product, pb);
                    
                    debugger;
                    
                    // update the fields
                    unitPriceField.value = up;
                    var quantity = parseInt(quantityField.value);
                    linePriceField.value = quantity * up;
                }else if (lineType == "Labor"){
                    // TODO:
                }
            }
        }
    }
    
    function getUnitPriceForProduct(product, pb){
        var i, l = pb.length, ret = 0;
        for(i = 0; i < l; i++){
            if(pb[i].key == "PARTSPRICING"){
                var allProductsInfo = pb[i].data, pl = allProductsInfo.length, j;
                for(j = 0; j < pl; j++){
                    // Shouldnt we be use the product ID?
                    if(allProductsInfo[j].Name == product.value1){
                        ret = allProductsInfo[i].UnitPrice;
                        break;
                    }
                }
            }
        }
        return ret;
    }
    
    function getItemForDetailRecordKey(key, record){
        
        key = "SVMXC" + "__" + key;
        var length = record.length, k, ret = null;
        for(k = 0; k < length; k++){
            var fld = record[k];
            if(fld.key == key){
                ret = fld;
                break;
            }
        }
        return ret;
    }
    
    SVMX.getPricingDefinition(context.detailRecords, function(pb){
        applyPriceBook(context.detailRecords, pb);
        RETURN(context);
    });
}

SVMXInitExpressionEngine({app : FlexApp, sessionId : "{!GETSESSIONID()}", orgNameSpace : "SVMXC"});


var context = '{"detailRecords":[{"pageLayoutId":"a1370000000FaXYAA0","aliasName":"a1370000000FaXYAA0","objName":"SVMXC__Quote_Line__c","records":[{"targetRecordAsKeyValue":[{"value":"test","key":"SVMXC__Line_Description__c"},{"value":"Parts","key":"SVMXC__Line_Type__c"},{"value":"test;2.0;Prod0001;","key":"objectToString"},{"value":"","key":"SVMXC__Unit_Price2__c"},{"value":"2.0","key":"SVMXC__Quantity2__c"},{"value1":"Product2","value":"01t70000003yWL3","key":"SVMXC__Product__c"},{"value":"","key":"SVMXC__Discount_Type__c"},{"value":"","key":"SVMXC__Discount__c"},{"value":"","key":"SVMXC__Line_Price2__c"}]},{"targetRecordAsKeyValue":[{"value":"some text","key":"SVMXC__Line_Description__c"},{"value1":"Product1","value":"01t70000003yWL2","key":"SVMXC__Product__c"},{"value":"Parts","key":"SVMXC__Line_Type__c"},{"value":";some text;3;","key":"objectToString"},{"value":"3","key":"SVMXC__Quantity2__c"},{"value":"","key":"SVMXC__Unit_Price2__c"},{"value":"","key":"SVMXC__Discount_Type__c"},{"value":"","key":"SVMXC__Discount__c"},{"value":"","key":"SVMXC__Line_Price2__c"}]}],"parentColumnName":"SVMXC__Quote__c"},{"pageLayoutId":"a1370000000FaXtAAK","aliasName":"a1370000000FaXtAAK","objName":"SVMXC__Quote_Line__c","records":[],"parentColumnName":"SVMXC__Quote__c"},{"pageLayoutId":"a1370000000FaXuAAK","aliasName":"a1370000000FaXuAAK","objName":"SVMXC__Quote_Line__c","records":[],"parentColumnName":"SVMXC__Quote__c"}],"sfmProcessId":"TDM019","headerRecord":{"pageLayoutId":"a1370000000FaXCAA0","records":[{"targetRecordAsKeyValue":[{"value":"","key":"SVMXC__Service_Order__c"},{"value1":"ABC Inc","value":"0017000000UlZ0gAAF","key":"SVMXC__Company__c"},{"value1":"John Bond","value":"0037000000ThwECAAZ","key":"SVMXC__Contact__c"},{"value1":"Accepted","value":"Accepted","key":"SVMXC__Status__c"},{"value":{"fullYear":2011,"month":11,"date":28,"hours":0,"minutes":0,"seconds":0,"milliseconds":0,"fullYearUTC":2011,"monthUTC":11,"dateUTC":27,"hoursUTC":18,"millisecondsUTC":0,"minutesUTC":30,"time":1325010600000,"secondsUTC":0,"timezoneOffset":-330,"day":3,"dayUTC":2},"key":"SVMXC__Valid_Until__c"},{"value":"0","key":"SVMXC__Total_Line_Price2__c"},{"value1":"Percent","value":"Percent","key":"SVMXC__Discount_Type__c"},{"value":"12.0","key":"SVMXC__Discount__c"},{"value":"-149.280","key":"SVMXC__Quote_Amount2__c"},{"value":"2011-12-06 11:47:17","key":"CreatedDate"},{"value":"https://na5-api.salesforce.com/services/Soap/c/7.0/00D700000009JVp","key":"SVMXC__EndpointURL__c"},{"value":"005700000017r9HAAQ","key":"OwnerId"},{"value":"00D700000009JVp!AQ8AQIjpAGrXpHD7QIATlN.ujhjpcytke8IWnphINdhDYQlk7fCitMLmTnbfjyOrbqQVP.4nsHxo6XLsucQTXmUJ7lngPKI1","key":"SVMXC__SESSION_ID__c"},{"value":"005700000017r9HAAQ","key":"CreatedById"},{"value":"Q-00002312","key":"Name"},{"value":"2011-12-27 06:31:17","key":"LastModifiedDate"},{"value":"USD","key":"CurrencyIsoCode"},{"value":"005700000018DaDAAU","key":"LastModifiedById"},{"value":"false","key":"IsDeleted"},{"value":"2011-12-27 06:31:18","key":"SystemModstamp"},{"value":"a0f70000002TnhtAAC","key":"Id"}],"targetRecordId":"a0f70000002Tnht"}],"objName":"SVMXC__Quote__c","parentColumnName":""},"eventType":"Field Change"}';
context = $.secureEvalJSON(context);
SVMXEvalExpression("(" + snippet.toString() +")(context)", context, id++);

});

</script>  
</apex:page>